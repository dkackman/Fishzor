@page "/"
@rendermode InteractiveWebAssembly
@using Microsoft.JSInterop
@using global::Fishzor.Client.Components
@inject IJSRuntime JSRuntime

<style>
    #fishTank {
        width: 100%;
        height: 100%;
    }
</style>

<div id="fishTank">
    <PageTitle>Fishy fishy fish</PageTitle>

    <button class="btn btn-primary" @onclick="AddFish">Add fish</button>
    <button class="btn btn-primary" @onclick="RemoveFish" disabled="@(_fishComponents.Count == 0)">Remove fish</button>
    @foreach (var fish in _fishComponents)
    {
        @fish
    }
</div>

@code {
    private List<RenderFragment> _fishComponents = new();
    private static readonly Random _random = new();

    private async Task AddFish()
    {
        // place the new fish at a random point within the tank
        var tankRect = await JSRuntime.InvokeAsync<ClientRect>("getTankRect");
        var left = tankRect.Width * _random.NextDouble();
        var top = tankRect.Height * _random.NextDouble();

        // Create a new RenderFragment representing the Fish component
        // and position it using style
        var fishComponent = new RenderFragment(builder =>
        {
            var seq = 0;
            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "style", $"position: absolute; left: {left}px; top: {top}px;");
            builder.OpenComponent<Components.Fish>(seq++);
            builder.CloseComponent();
            builder.CloseElement();
        });

        _fishComponents.Add(fishComponent);
    }

    private void RemoveFish()
    {
        if (_fishComponents.Count > 0)
        {
            _fishComponents.RemoveAt(_fishComponents.Count - 1);
        }
    }
}